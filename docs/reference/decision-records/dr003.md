# DR-003: Use Three-Layer Testing Approach (ATDD/BDD/TDD)

## Status

- [x] Accepted
- [ ] Proposed
- [ ] Rejected
- [ ] Deprecated
- [ ] Superseded

**Date**: 2025-11-03

---

## Context

The platform requires testing that:

1. Captures business requirements in executable form
2. Enables collaboration between business stakeholders and developers
3. Provides traceability from requirements to code
4. Supports audit and compliance needs
5. Works across multiple languages (Go, TypeScript, Python, Bash)

**Problem**: How to bridge business requirements and technical implementation while maintaining traceability?

---

## Decision

Use **three-layer testing** with a single `specification.feature` file combining ATDD and BDD layers:

**Layer 1 - ATDD (Acceptance Test-Driven Development)**:

- Tool: Godog
- Format: Gherkin Rule blocks in `specification.feature`
- Purpose: Define acceptance criteria (from Example Mapping Blue Cards)

**Layer 2 - BDD (Behavior-Driven Development)**:

- Tool: Godog
- Format: Gherkin Scenario blocks nested under Rules in `specification.feature`
- Purpose: Executable examples (from Example Mapping Green Cards)

**Layer 3 - TDD (Test-Driven Development)**:

- Tool: Go test
- Format: `*_test.go` files
- Purpose: Unit tests for implementation

### File Organization

```text
specs/<module>/<feature>/
└── specification.feature        # ATDD (Rules) + BDD (Scenarios)

src/<module>/tests/
└── steps_test.go                # Step definitions

src/<module>/
└── *_test.go                    # Unit tests
```

### Example Structure

```gherkin
Feature: cli_init-project

  Rule: System initializes project structure

    @success @ac1
    Scenario: Initialize in empty directory
      Given I am in an empty directory
      When I run "simply init"
      Then the project structure should be created
```

**Mapping**:

- Feature → Feature ID (traceability)
- Rule → Blue Card (acceptance criterion)
- Scenario → Green Card (concrete example)
- @ac1 tag → Links to first acceptance criterion

---

## Consequences

### Positive

- **Traceability**: Feature ID links specifications to unit tests, @ac tags link scenarios to acceptance criteria
- **Collaboration**: Rule blocks readable by stakeholders, shared vocabulary from Event Storming
- **Single source**: specification.feature combines ATDD and BDD, no duplication
- **Compliance**: Verification tags (@IV/@PV) support regulatory requirements
- **Multi-language**: Gherkin works across all language implementations

### Negative

- **Learning curve**: Gherkin syntax, Rule/Scenario hierarchy, DDD concepts (Event Storming, Example Mapping)
- **Workshop overhead**: Requires Event Storming and Example Mapping facilitation
- **Execution time**: Specifications + unit tests slower than unit tests alone

---

## Alternatives Considered

### 1. Separate ATDD and BDD Files

Use separate files for acceptance criteria (Markdown) and scenarios (Gherkin).

**Why Not Chosen**: Causes duplication, synchronization issues, and additional tool dependency. Single specification.feature eliminates these problems.

### 2. TDD with Separate Documentation

Write unit tests and maintain separate requirements documents.

**Why Not Chosen**: Documentation diverges from tests, no executable requirements, poor traceability.

### 3. BDD Without Rule Blocks

Use Gherkin scenarios without Rule blocks for organization.

**Why Not Chosen**: No acceptance criteria structure, hard to map Example Mapping outputs, missing ATDD layer.

---

## Implementation

### Test Execution

```bash
# Run specifications (ATDD + BDD)
godog specs/**/specification.feature

# Run unit tests (TDD)
go test ./...

# Run by verification type
godog --tags="@IV" specs/**/specification.feature
godog --tags="@PV" specs/**/specification.feature
```

### Workflow

1. Event Storming → Discover vocabulary → Document glossary
2. Example Mapping → Apply vocabulary → Produce cards
3. Convert cards → specification.feature (Feature → Rule → Scenario)
4. Implement step definitions → src/[module]/tests/steps_test.go
5. Run tests → Validate → Iterate

**Card Mapping**:

- Yellow Card (User Story) → Feature description
- Blue Cards (Acceptance Criteria) → Rule blocks
- Green Cards (Examples) → Scenario blocks
- Red Cards (Questions) → issues.md

---

## Related Decisions

- [DR-007: Verification Tags for Regulatory Compliance](dr007.md)
- [DR-008: Feature Specifications Structure](dr008.md)
