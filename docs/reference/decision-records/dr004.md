# DR-004: Use Model Context Protocol (MCP) for VSCode Extension

## Status

- [x] Accepted
- [ ] Proposed
- [ ] Rejected
- [ ] Deprecated
- [ ] Superseded

**Date**: 2025-11-03

---

## Context

The VSCode extension needs to execute actions like Git operations, commit message generation, and custom commands. This requires:

1. **Backend logic execution** - Complex operations (Git, AI analysis, API calls)
2. **Language independence** - Extension is TypeScript, but backend could be any language
3. **Process isolation** - Crashes shouldn't affect VSCode
4. **Extensibility** - Easy to add new actions without modifying extension
5. **AI integration** - Support for AI-powered features (commit message generation)
6. **Multi-server architecture** - Different specialized servers (Git, docs, GitHub, PowerShell)

Traditional approaches:

- **Direct API calls** - Extension calls VSCode API directly (limited to TypeScript)
- **HTTP server** - Backend runs as HTTP service (overhead, port management)
- **Native Node.js modules** - Compile native code for each platform (complex, fragile)

**Problem Statement**: How should the extension communicate with backend services to enable multi-language support, process isolation, and AI integration?

---

## Decision

We will use **Model Context Protocol (MCP)** for communication between the VSCode extension and backend servers.

### Architecture

```text
VSCode Extension (TypeScript)
    ↓ spawns process
MCP Server (Go/Python/etc.)
    ↓ JSON-RPC 2.0 via stdin/stdout
Tools/Actions execution
    ↓ JSON response
Extension displays result
```

### Key Aspects

**1. Communication Protocol**:

- JSON-RPC 2.0 over stdin/stdout
- Line-delimited JSON messages
- Standard request/response pattern

**2. Server Implementation**:

- Servers written in any language (primarily Go)
- Implement three methods: `initialize`, `tools/list`, `tools/call`
- Stateless per-request execution

**3. Multiple Specialized Servers**:

```text
.mcp.json configuration:
- vscode: Git operations and VSCode actions
- pwsh: PowerShell command execution
- docs: Documentation management
- github: GitHub API integration
```

**4. Process Model**:

- Extension spawns server process per operation
- Server processes input from stdin
- Server writes JSON-RPC responses to stdout
- Server logs to stderr (visible in Debug Console)
- Process exits after handling request

---

## Consequences

### Positive

**1. Language Independence**:

- Extension is TypeScript
- Servers can be Go, Python, Rust, etc.
- Choose best language for each domain
- No need for language bindings or FFI

**2. Process Isolation**:

- Server crashes don't affect VSCode
- Memory leaks contained to server process
- Easy to restart failed servers
- Separate resource limits per server

**3. Extensibility**:

- Add new servers without modifying extension
- Configure servers declaratively in `.mcp.json`
- Multiple specialized servers for different domains
- Easy to test servers independently

**4. Standard Protocol**:

- JSON-RPC 2.0 is well-established
- Good tooling and debugging support
- Clear message format and error codes
- Language-agnostic standard

**5. AI Integration**:

- MCP designed for AI tool calling
- Structured input/output schemas
- Context management support
- Tool discovery via `tools/list`

**6. Testability**:

- Test servers independently of VSCode
- Send JSON-RPC commands manually
- Mock server responses easily
- Unit test step implementations

### Negative

**1. Process Overhead**:

- Spawning process per operation
- Startup time for each server invocation
- Not suitable for high-frequency calls
- Memory overhead from multiple processes

**2. Communication Complexity**:

- Must implement JSON-RPC protocol
- Error handling across process boundary
- No shared state between calls
- Serialization/deserialization overhead

**3. Debugging Challenges**:

- Cross-process debugging more complex
- Must correlate extension and server logs
- stderr output only visible in Debug Console
- Request/response debugging requires logging

**4. Limited Shared State**:

- No persistent server state
- Each request starts fresh server
- Must pass all context in each request
- Caching requires external storage

**5. Protocol Learning Curve**:

- Team must understand JSON-RPC
- MCP-specific conventions
- stdin/stdout communication patterns
- Error handling conventions

---

## Alternatives Considered

### Alternative 1: Direct VSCode API Calls

**Description**: Implement all functionality in TypeScript using VSCode APIs directly.

**Pros**:

- No process overhead
- Simple to debug
- Fast execution
- Direct access to VSCode APIs

**Cons**:

- Limited to TypeScript/JavaScript
- All code runs in extension process
- Harder to isolate failures
- Can't use Go/Python/Rust libraries
- Difficult to add AI features

**Why Not Chosen**: Language limitation prevents using best tools for each job (e.g., Go for Git operations, Python for AI).

### Alternative 2: HTTP/REST Server

**Description**: Run backend as HTTP server, extension makes REST calls.

**Pros**:

- Standard HTTP tooling
- Easy to test with curl/Postman
- Can serve multiple clients
- Familiar to developers

**Cons**:

- Port management complexity
- Server lifecycle management
- Security concerns (open ports)
- Network overhead for local calls
- Must handle server not running
- Harder to distribute (separate install)

**Why Not Chosen**: Port management and server lifecycle add unnecessary complexity for local-only communication.

### Alternative 3: Native Node.js Modules

**Description**: Write native Node.js modules (C++/Rust compiled to .node files).

**Pros**:

- In-process execution
- Fast performance
- Direct memory access
- npm packaging

**Cons**:

- Must compile for each platform (Windows/Mac/Linux × x64/ARM)
- Complex build process
- Fragile across Node.js versions
- Difficult debugging
- Language limited to C++/Rust with N-API
- Can crash Node.js process

**Why Not Chosen**: Platform-specific compilation too complex, and crashes affect VSCode stability.

### Alternative 4: Language Server Protocol (LSP)

**Description**: Use LSP for extension-backend communication.

**Pros**:

- Standard protocol in VSCode ecosystem
- Good VSCode integration
- Persistent server connection

**Cons**:

- Designed for language features (completion, diagnostics)
- Not ideal for general actions
- More overhead than needed
- Complex protocol for simple actions

**Why Not Chosen**: LSP designed for different use case (language intelligence), MCP better fit for tool/action execution.

---

## Implementation Details

### Server Structure

```go
package main

import (
    "bufio"
    "encoding/json"
    "os"
)

func main() {
    scanner := bufio.NewScanner(os.Stdin)
    for scanner.Scan() {
        line := scanner.Text()
        var request JSONRPCRequest
        json.Unmarshal([]byte(line), &request)

        response := handleRequest(request)

        output, _ := json.Marshal(response)
        fmt.Println(string(output))
    }
}
```

### Extension Integration

```typescript
function spawnMCPServer(serverPath: string): ChildProcess {
    return spawn('bash', [serverPath], {
        stdio: ['pipe', 'pipe', 'pipe']
    });
}

async function callMCPServer(server: string, action: string, data: any) {
    const process = spawnMCPServer(config.mcpServers[server]);

    // Send JSON-RPC request to stdin
    process.stdin.write(JSON.stringify({
        jsonrpc: '2.0',
        id: 1,
        method: 'tools/call',
        params: { name: action, arguments: data }
    }) + '\n');

    // Read JSON-RPC response from stdout
    const response = await readResponse(process.stdout);

    return response.result;
}
```

### Configuration (.mcp.json)

```json
{
  "mcpServers": {
    "vscode": {
      "command": "bash",
      "args": ["src/mcp/vscode/run.sh"]
    },
    "github": {
      "command": "bash",
      "args": ["src/mcp/github/run.sh"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

---

## References

- [VSCode Extension Architecture](../../explanation/vscode-extension-architecture.md)
- [How to Work with MCP Servers](../../how-to-guides/vscode-extension/work-with-mcp-servers.md)
- [VSCode Extension Reference](../../reference/vscode-extension.md)

---

## Related Decisions

- [DR-006: Multi-Language Mono-Repository](dr006.md) - Enables using Go for servers, TypeScript for extension
